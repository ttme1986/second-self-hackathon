<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Second-Self Architecture</title>
  <script type="module">
    import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.esm.min.mjs';
    mermaid.initialize({
      startOnLoad: true,
      theme: 'base',
      themeVariables: {
        primaryColor: '#6366f1',
        primaryTextColor: '#fff',
        primaryBorderColor: '#4f46e5',
        lineColor: '#94a3b8',
        secondaryColor: '#1e1b4b',
        tertiaryColor: '#f1f5f9',
        fontFamily: 'Inter, system-ui, sans-serif',
      },
      flowchart: {
        useMaxWidth: false,
        htmlLabels: true,
        curve: 'basis',
      },
    });
  </script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: Inter, system-ui, sans-serif;
      background: #0f172a;
      color: #e2e8f0;
      min-height: 100vh;
      padding: 24px;
    }
    h1 {
      text-align: center;
      font-size: 1.75rem;
      margin-bottom: 8px;
      color: #f8fafc;
    }
    .subtitle {
      text-align: center;
      color: #94a3b8;
      margin-bottom: 24px;
      font-size: 0.9rem;
    }
    .legend {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 16px;
      margin-bottom: 24px;
    }
    .legend-item {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 0.8rem;
      color: #cbd5e1;
    }
    .legend-swatch {
      width: 16px;
      height: 16px;
      border-radius: 4px;
    }
    .diagram-container {
      background: #1e293b;
      border: 1px solid #334155;
      border-radius: 12px;
      padding: 32px;
      overflow: auto;
      max-width: 100%;
    }
    .mermaid {
      display: flex;
      justify-content: center;
    }
    .gemini-note {
      text-align: center;
      margin-top: 16px;
      padding: 12px;
      background: rgba(66, 133, 244, 0.1);
      border: 1px solid rgba(66, 133, 244, 0.3);
      border-radius: 8px;
      color: #93c5fd;
      font-size: 0.85rem;
    }
    .stats {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 24px;
      margin-top: 16px;
      padding: 12px;
      background: rgba(99, 102, 241, 0.1);
      border: 1px solid rgba(99, 102, 241, 0.3);
      border-radius: 8px;
    }
    .stat {
      text-align: center;
    }
    .stat-value {
      font-size: 1.5rem;
      font-weight: 700;
      color: #818cf8;
    }
    .stat-label {
      font-size: 0.75rem;
      color: #94a3b8;
    }
  </style>
</head>
<body>
  <h1>Second-Self Architecture</h1>
  <p class="subtitle">Component dependency diagram with Gemini 3 integration points</p>

  <div class="legend">
    <div class="legend-item"><div class="legend-swatch" style="background:#6366f1"></div> Pages</div>
    <div class="legend-item"><div class="legend-swatch" style="background:#818cf8"></div> Components</div>
    <div class="legend-item"><div class="legend-swatch" style="background:#8b5cf6"></div> Hooks</div>
    <div class="legend-item"><div class="legend-swatch" style="background:#ec4899"></div> Agents</div>
    <div class="legend-item"><div class="legend-swatch" style="background:#14b8a6"></div> Services</div>
    <div class="legend-item"><div class="legend-swatch" style="background:#f59e0b"></div> Data Layer</div>
    <div class="legend-item"><div class="legend-swatch" style="background:#64748b"></div> Providers</div>
    <div class="legend-item"><div class="legend-swatch" style="background:#4285f4;border:2px solid #1a73e8"></div> Gemini API</div>
    <div class="legend-item"><div class="legend-swatch" style="background:#ff9100;border:2px solid #e65100"></div> Firebase</div>
  </div>

  <div class="diagram-container">
    <pre class="mermaid">
%%{ init: { 'theme': 'base', 'themeVariables': { 'primaryColor': '#6366f1', 'primaryTextColor': '#fff', 'primaryBorderColor': '#4f46e5', 'lineColor': '#94a3b8', 'secondaryColor': '#1e1b4b', 'tertiaryColor': '#f1f5f9' } } }%%

graph TB
  subgraph USER["User Interface - Pages"]
    Login["Login.tsx"]
    Hub["Hub.tsx"]
    Chat["Chat.tsx"]
    Reflect["Reflect.tsx"]
    Settings["Settings.tsx"]
  end

  subgraph COMPONENTS["Key Components"]
    ChatHeader["ChatHeader"]
    ChatActionBar["ChatActionBar"]
    ChatRecapModal["ChatRecapModal"]
    CameraView["CameraViewfinder"]
    PermSelector["PermissionSelector"]
    TodaysFocus["TodaysFocus"]
    InsightCard["InsightCard"]
    GoalCard["GoalCard"]
    EmotionTrend["EmotionTrend"]
  end

  subgraph HOOKS["React Hooks"]
    useVoice["useVoiceSession"]
    useTranscript["useTranscript"]
    usePipeline["useBlackboardPipeline"]
    useSuggested["useSuggestedActions"]
    useEmotion["useEmotionalTracking"]
    useAttach["useAttachments"]
  end

  subgraph AGENTS["Agent Pipeline - Blackboard Pattern"]
    BB["Blackboard&lt;br/&gt;Task Queue + Event Bus"]
    Analyzer["AnalyzerAgent&lt;br/&gt;extractClaimsAndActions()&lt;br/&gt;thought signatures + dedup"]
    Validator["ValidatorAgent&lt;br/&gt;embedText() + cosineSim&lt;br/&gt;detectConflict()"]
    Publisher["ActionPublishAgent&lt;br/&gt;Surface to UI + Persist"]
  end

  subgraph SERVICES["Services"]
    LiveAudio["liveAudioService&lt;br/&gt;WebSocket + Chat API"]
    MemCtx["memoryContext&lt;br/&gt;System Prompt Builder"]
    FocusGen["focusGenerator&lt;br/&gt;Daily Focus + Insights"]
    EmotionTrack["emotionTracker&lt;br/&gt;Trends + Wellness"]
    ActionExec["actionExecutor&lt;br/&gt;Draft + Execute"]
    StorageUp["storageUpload"]
  end

  subgraph DATA["Data Layer"]
    Backend["backend.ts&lt;br/&gt;API Facade"]
    LocalStore["localStore.ts&lt;br/&gt;localStorage"]
    FSStore["firestoreStore.ts"]
    FSSync["firestoreSync.ts"]
    WriteGate["firestoreWriteGate&lt;br/&gt;Deferred Writes"]
  end

  subgraph PROVIDERS["Context Providers"]
    AuthProv["AuthProvider"]
    ProfileProv["ProfileProvider"]
    OLProv["OpenLoopsProvider"]
  end

  subgraph LIB["Lib / Utilities"]
    FirebaseLib["firebase.ts&lt;br/&gt;SDK Init"]
    Analytics["analytics.ts"]
    Evidence["evidence.ts"]
  end

  subgraph EXTERNAL["External Services"]
    direction TB
    GeminiLive["Gemini Live API&lt;br/&gt;bidiGenerateContent (WebSocket)&lt;br/&gt;gemini-2.5-flash-native-audio-preview-12-2025&lt;br/&gt;Voice: Kore | Transcription | VAD"]:::gemini
    GeminiPro["Gemini 3 Pro&lt;br/&gt;generateContent (REST)&lt;br/&gt;gemini-3-pro-preview&lt;br/&gt;Agentic Vision (primary)&lt;br/&gt;Code Exec | Thinking LOW"]:::gemini
    GeminiFlash["Gemini 3 Flash&lt;br/&gt;generateContent (REST)&lt;br/&gt;gemini-3-flash-preview&lt;br/&gt;Thinking LOW/MED/HIGH | JSON Output&lt;br/&gt;Search | URL Context"]:::gemini
    GeminiEmbed["Gemini Embedding&lt;br/&gt;embedContent (REST)&lt;br/&gt;gemini-embedding-001&lt;br/&gt;768-dim vectors"]:::gemini
    FirebaseAuth["Firebase Auth&lt;br/&gt;Google OAuth"]:::firebase
    Firestore["Cloud Firestore&lt;br/&gt;users/uid/*"]:::firebase
    FireStorage["Firebase Storage&lt;br/&gt;Transcripts / Photos"]:::firebase
  end

  %% Page -> Component
  Chat --> ChatHeader & ChatActionBar & ChatRecapModal & CameraView & PermSelector
  Hub --> TodaysFocus & InsightCard
  Reflect --> GoalCard & EmotionTrend

  %% Page -> Hooks
  Chat --> useVoice & useTranscript & usePipeline & useSuggested & useEmotion & useAttach
  Hub --> FocusGen & EmotionTrack

  %% Hook -> Service
  useVoice --> LiveAudio & MemCtx
  useTranscript --> BB
  usePipeline --> Analyzer & Validator & Publisher
  useSuggested --> ActionExec
  useEmotion --> Backend

  %% Agent pipeline
  BB -->|turn.ingest| Analyzer
  Analyzer -->|proposed| BB
  BB -->|proposed| Validator
  Validator -->|validated| BB
  BB -->|validated| Publisher

  %% Agent -> Backend
  Analyzer --> Backend
  Validator --> Backend
  Publisher --> Backend

  %% Service -> Backend
  MemCtx --> Backend
  FocusGen --> Backend & EmotionTrack
  EmotionTrack --> Backend
  ActionExec --> Backend

  %% Gemini connections (thick blue)
  LiveAudio ==>|bidiGenerateContent| GeminiLive
  LiveAudio ==>|ai.chats.create| GeminiFlash
  Backend ==>|"analyzeImage&lt;br/&gt;(code exec + thinking LOW)"| GeminiPro
  Backend ==>|"extractClaims, detectConflict&lt;br/&gt;detectEmotion, summarize&lt;br/&gt;consolidateMemory, analyzeImage (fallback)&lt;br/&gt;goalMilestones, checkInResponse"| GeminiFlash
  Backend ==>|"embedText, embedQuery"| GeminiEmbed
  ActionExec ==>|"generateDraft&lt;br/&gt;Search + URL tools"| GeminiFlash
  FocusGen ==>|"todaysFocus, insights&lt;br/&gt;code execution"| GeminiFlash

  %% Data layer
  Backend --> LocalStore & FSStore & WriteGate
  FSStore --> WriteGate & FirebaseLib

  %% Firebase
  FSStore --> Firestore
  FSSync --> Firestore
  StorageUp --> FireStorage
  AuthProv --> FirebaseAuth & Backend

  Login --> AuthProv
  ProfileProv --> Backend
  OLProv --> Backend

  Backend -->|commitSession| Firestore

  classDef gemini fill:#4285f4,stroke:#1a73e8,color:#fff,stroke-width:3px
  classDef firebase fill:#ff9100,stroke:#e65100,color:#fff,stroke-width:2px
  classDef page fill:#6366f1,stroke:#4f46e5,color:#fff
  classDef hook fill:#8b5cf6,stroke:#7c3aed,color:#fff
  classDef agent fill:#ec4899,stroke:#db2777,color:#fff
  classDef service fill:#14b8a6,stroke:#0d9488,color:#fff
  classDef data fill:#f59e0b,stroke:#d97706,color:#fff
  classDef auth fill:#64748b,stroke:#475569,color:#fff
  classDef component fill:#818cf8,stroke:#6366f1,color:#fff

  class Login,Hub,Chat,Reflect,Settings page
  class ChatHeader,ChatActionBar,ChatRecapModal,CameraView,PermSelector,TodaysFocus,InsightCard,GoalCard,EmotionTrend component
  class useVoice,useTranscript,usePipeline,useSuggested,useEmotion,useAttach hook
  class BB,Analyzer,Validator,Publisher agent
  class LiveAudio,MemCtx,FocusGen,EmotionTrack,ActionExec,StorageUp service
  class Backend,LocalStore,FSStore,FSSync,WriteGate data
  class AuthProv,ProfileProv,OLProv auth
  class FirebaseLib,Analytics,Evidence auth

  linkStyle 38,39,40,41,42,43,44 stroke:#4285f4,stroke-width:3px
    </pre>
  </div>

  <div class="gemini-note">
    Thick blue lines indicate <strong>Gemini API integration points</strong>. All 4 models are used:
    <strong>gemini-2.5-flash-native-audio-preview-12-2025</strong> (Live voice),
    <strong>gemini-3-pro-preview</strong> (agentic vision, primary),
    <strong>gemini-3-flash-preview</strong> (text generation, extraction, analysis),
    <strong>gemini-embedding-001</strong> (semantic search &amp; dedup)
  </div>

  <div class="stats">
    <div class="stat"><div class="stat-value">15+</div><div class="stat-label">Gemini Integration Points</div></div>
    <div class="stat"><div class="stat-value">4</div><div class="stat-label">Gemini Models</div></div>
    <div class="stat"><div class="stat-value">3</div><div class="stat-label">Agent Pipeline Stages</div></div>
    <div class="stat"><div class="stat-value">6</div><div class="stat-label">React Hooks</div></div>
    <div class="stat"><div class="stat-value">6</div><div class="stat-label">Services</div></div>
    <div class="stat"><div class="stat-value">5</div><div class="stat-label">Pages</div></div>
    <div class="stat"><div class="stat-value">0</div><div class="stat-label">Backend Servers</div></div>
  </div>
</body>
</html>
